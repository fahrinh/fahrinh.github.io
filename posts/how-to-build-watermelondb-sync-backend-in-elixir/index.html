<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title class=pjax-title>How to Build WatermelonDB Sync Backend in Elixir - Fahri NH</title><meta name=description content="WatermelonDB is a reactive database for React frontend application that supports data synchronization. This tutorial explains the concept and shows step by step how to build sync backend using Phoenix (Elixir)"><meta property="og:title" content="How to Build WatermelonDB Sync Backend in Elixir"><meta property="og:description" content="WatermelonDB is a reactive database for React frontend application that supports data synchronization. This tutorial explains the concept and shows step by step how to build sync backend using Phoenix (Elixir)"><meta property="og:type" content="article"><meta property="og:url" content="https://fahri.id/posts/how-to-build-watermelondb-sync-backend-in-elixir/"><meta property="og:image" content="https://fahri.id/images/watermelondb.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-04-24T21:27:12+07:00"><meta property="article:modified_time" content="2020-04-24T21:27:12+07:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://fahri.id/images/watermelondb.png"><meta name=twitter:title content="How to Build WatermelonDB Sync Backend in Elixir"><meta name=twitter:description content="WatermelonDB is a reactive database for React frontend application that supports data synchronization. This tutorial explains the concept and shows step by step how to build sync backend using Phoenix (Elixir)"><meta name=application-name content="Fahri NH"><meta name=apple-mobile-web-app-title content="Fahri NH"><meta name=theme-color content="#f8f8f8"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=canonical href=https://fahri.id/posts/how-to-build-watermelondb-sync-backend-in-elixir/><link rel=prev href=https://fahri.id/posts/generate-sequential-uuidv4-in-elixir/><link rel=next href=https://fahri.id/posts/building-an-offline-first-react-web-app-using-watermelondb-in-phoenix-elixir/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/fontawesome-free/all.min.css><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/animate/animate.min.css><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"How to Build WatermelonDB Sync Backend in Elixir","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/fahri.id\/posts\/how-to-build-watermelondb-sync-backend-in-elixir\/"},"genre":"posts","keywords":"WatermelonDB, Sync Backend","wordcount":2113,"url":"https:\/\/fahri.id\/posts\/how-to-build-watermelondb-sync-backend-in-elixir\/","datePublished":"2020-04-24T21:27:12+07:00","dateModified":"2020-04-24T21:27:12+07:00","publisher":{"@type":"Organization","name":"Fahri"},"author":{"@type":"Person","name":"Fahri"},"description":""}</script></head><body header-desktop header-mobile><script type=text/javascript>function setTheme(e){document.body.setAttribute("theme",e),document.documentElement.style.setProperty("color-scheme",e==="light"?"light":"dark")}function saveTheme(e){window.localStorage&&localStorage.setItem("theme",e)}function getMeta(e){const t=document.getElementsByTagName("meta");for(let n=0;n<t.length;n++)if(t[n].getAttribute("name")===e)return t[n];return""}if(window.localStorage&&localStorage.getItem("theme")){let e=localStorage.getItem("theme");e==="light"||e==="dark"||e==="black"?setTheme(e):setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")}else""==="light"||""==="dark"||""==="black"?(setTheme(""),saveTheme("")):(saveTheme("auto"),setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"));let metaColors={light:"#f8f8f8",dark:"#252627",black:"#000000"};getMeta("theme-color").content=metaColors[document.body.getAttribute("theme")]</script><div id=back-to-top></div><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Fahri NH">Fahri NH</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/categories/>Categories </a><a class=menu-item href=/about/ title=About>About </a><span class="menu-item delimiter"></span><a href=# onclick=return!1 class="menu-item language" title="Select Language">English<i class="fas fa-chevron-right fa-fw"></i>
<select class=language-select title="Select Language" id=language-select-desktop onchange="location=this.value"><option value=/posts/how-to-build-watermelondb-sync-backend-in-elixir/ selected>English</option></select>
</a><a href=# onclick=return!1 class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Fahri NH">Fahri NH</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/tags/ title>Tags</a><a class=menu-item href=/categories/ title>Categories</a><a class=menu-item href=/about/ title=About>About</a><a href=# onclick=return!1 class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i>
</a><a href=# onclick=return!1 class=menu-item title="Select Language">English<i class="fas fa-chevron-right fa-fw"></i>
<select class=language-select title="Select Language" onchange="location=this.value"><option value=/posts/how-to-build-watermelondb-sync-backend-in-elixir/ selected>English</option></select></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class="toc-content always-active" id=toc-content-auto><nav id=TableOfContents><ul><li><a href=#pull-operation>Pull Operation</a></li><li><a href=#push-operation>Push Operation</a></li><li><a href=#changes-example><code>changes</code> Example</a></li><li><a href=#sync-flow>Sync Flow</a></li></ul><ul><li><a href=#using-auto-incrementing-counter-version--timestamp-for-tracking-changes>Using Auto-incrementing Counter (Version) + Timestamp for Tracking Changes</a></li><li><a href=#workaround-for-sync-on-client-side>Workaround for Sync on Client Side</a><ul><li><a href=#sync-flow-workaround>Sync Flow Workaround</a></li></ul></li></ul><ul><li><a href=#database-design>Database Design</a></li><li><a href=#determining-data-changes>Determining Data Changes</a></li></ul><ul><li><a href=#sync-endpoint>Sync Endpoint</a><ul><li><a href=#controller>Controller</a></li></ul></li><li><a href=#push>Push</a><ul><li><a href=#conflict-detection>Conflict Detection</a></li><li><a href=#storing-record-changes>Storing Record Changes</a></li></ul></li><li><a href=#pull>Pull</a></li><li><a href=#run-the-backend>Run the Backend</a></li></ul></nav></div></div><script>document.getElementsByTagName("main")[0].setAttribute("pageStyle","normal")</script><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC","true")</script><article class="page single"><h1 class="single-title animate__animated animate__flipInX">How to Build WatermelonDB Sync Backend in Elixir</h1><div class=post-meta><div class=post-meta-line><span class=post-author><i class="author fas fa-user-circle fa-fw"></i><a href=/ title=Author rel=author class=author>Fahri</a>
</span>&nbsp;<span class=post-category>included in </span>&nbsp;<span class=post-category>categories <a href=/categories/elixir/><i class="far fa-folder fa-fw"></i>Elixir</a>&nbsp;<a href=/categories/phoenix/><i class="far fa-folder fa-fw"></i>Phoenix</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2020-04-24>2020-04-24</time>&nbsp;<i class="far fa-edit fa-fw"></i>&nbsp;<time datetime=2020-04-24>2020-04-24</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;2113 words&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;10 minutes&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#pull-operation>Pull Operation</a></li><li><a href=#push-operation>Push Operation</a></li><li><a href=#changes-example><code>changes</code> Example</a></li><li><a href=#sync-flow>Sync Flow</a></li></ul><ul><li><a href=#using-auto-incrementing-counter-version--timestamp-for-tracking-changes>Using Auto-incrementing Counter (Version) + Timestamp for Tracking Changes</a></li><li><a href=#workaround-for-sync-on-client-side>Workaround for Sync on Client Side</a><ul><li><a href=#sync-flow-workaround>Sync Flow Workaround</a></li></ul></li></ul><ul><li><a href=#database-design>Database Design</a></li><li><a href=#determining-data-changes>Determining Data Changes</a></li></ul><ul><li><a href=#sync-endpoint>Sync Endpoint</a><ul><li><a href=#controller>Controller</a></li></ul></li><li><a href=#push>Push</a><ul><li><a href=#conflict-detection>Conflict Detection</a></li><li><a href=#storing-record-changes>Storing Record Changes</a></li></ul></li><li><a href=#pull>Pull</a></li><li><a href=#run-the-backend>Run the Backend</a></li></ul></nav></div></div><div class=content id=content><h1 id=watermelondb class=headerLink><a href=#watermelondb class=header-mark></a>WatermelonDB</h1><p><a href=https://github.com/Nozbe/WatermelonDB target=_blank rel="noopener noreferrer">WatermelonDB</a> is a reactive database for React frontend application that supports data synchronization.</p><p><a class=lightgallery href="https://www.plantuml.com/plantuml/proxy?src=https://raw.githubusercontent.com/fahrinh/my-blog/master/diagram/watermelondb.plantuml" title=WatermelonDB data-thumbnail="https://www.plantuml.com/plantuml/proxy?src=https://raw.githubusercontent.com/fahrinh/my-blog/master/diagram/watermelondb.plantuml"><img class=lazyload data-src="https://www.plantuml.com/plantuml/proxy?src=https://raw.githubusercontent.com/fahrinh/my-blog/master/diagram/watermelondb.plantuml" data-srcset="https://www.plantuml.com/plantuml/proxy?src=https://raw.githubusercontent.com/fahrinh/my-blog/master/diagram/watermelondb.plantuml, https://www.plantuml.com/plantuml/proxy?src=https://raw.githubusercontent.com/fahrinh/my-blog/master/diagram/watermelondb.plantuml 1.5x, https://www.plantuml.com/plantuml/proxy?src=https://raw.githubusercontent.com/fahrinh/my-blog/master/diagram/watermelondb.plantuml 2x" data-sizes=auto alt="https://www.plantuml.com/plantuml/proxy?src=https://raw.githubusercontent.com/fahrinh/my-blog/master/diagram/watermelondb.plantuml"></a></p><p>What I like about this database is you can bring your own sync backend (HTTP-based) as long as it complies with this spec:</p><table><thead><tr><th>Operation</th><th style=text-align:center>Request Params / Body</th><th style=text-align:center>Response Body</th></tr></thead><tbody><tr><td>Pull</td><td style=text-align:center>- <code>lastPulledAt</code>: <em>integer, Unix time in milliseconds (ms)</em></td><td style=text-align:center>- <code>changes</code>: <em>(JSON)</em> - <code>timestamp</code>: <em>integer, Unix time in milliseconds (ms)</em></td></tr><tr><td>Push</td><td style=text-align:center>- <code>changes</code>: <em>(JSON)</em> - <code>lastPulledAt</code>: <em>integer, Unix time in milliseconds (ms)</em></td><td style=text-align:center><em>X</em></td></tr></tbody></table><p>The following is a brief how pull and push operation works. Please refer to <a href=https://nozbe.github.io/WatermelonDB/Advanced/Sync.html target=_blank rel="noopener noreferrer">Sync documentation</a> for the details</p><h2 id=pull-operation class=headerLink><a href=#pull-operation class=header-mark></a>Pull Operation</h2><p>Request:</p><ul><li><code>lastPulledAt</code> is a timestamp retrieved in the last/previous pull operation</li></ul><p>Response:</p><ul><li><code>changes</code> is a JSON containing changes of data (created, updated, deleted) since <code>lastPulledAt</code> at server</li><li><code>timestamp</code> is a timestamp that will replace <code>lastPulledAt</code> for the next pull operation.</li></ul><h2 id=push-operation class=headerLink><a href=#push-operation class=header-mark></a>Push Operation</h2><p>Request:</p><ul><li><code>changes</code> is a JSON containing data changes on the client (local) that will be applied by server on server DB.</li><li><code>lastPulledAt</code> is a timestamp retrieved in the last/previous pull operation. This is for conflict detection. Server compare modification time of each row of <code>changes</code> on server DB with <code>lastPulledAt</code>. If it is greater, there is a conflict.</li></ul><p>Response:</p><ul><li>No specified response</li></ul><h2 id=changes-example class=headerLink><a href=#changes-example class=header-mark></a><code>changes</code> Example</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;posts&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;created&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;d1633195-156f-4f9d-9ccf-7740203b080e&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;_status&#34;</span><span class=p>:</span> <span class=s2>&#34;created&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;_changed&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;title&#34;</span><span class=p>:</span> <span class=s2>&#34;Phoenix&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;content&#34;</span><span class=p>:</span> <span class=s2>&#34;Phoenix is a web framework for Elixir&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;likes&#34;</span><span class=p>:</span> <span class=mi>200</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;created_at&#34;</span><span class=p>:</span> <span class=mi>1588400731806</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;updated_at&#34;</span><span class=p>:</span> <span class=mi>1588400731806</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;updated&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;2d7c6a82-eb04-47b1-be52-6f8f6cf806ff&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;_status&#34;</span><span class=p>:</span> <span class=s2>&#34;updated&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;_changed&#34;</span><span class=p>:</span> <span class=s2>&#34;updated_at,title,content,likes&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;title&#34;</span><span class=p>:</span> <span class=s2>&#34;Elixir&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;content&#34;</span><span class=p>:</span> <span class=s2>&#34;Elixir is amazing&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;likes&#34;</span><span class=p>:</span> <span class=mi>100</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;created_at&#34;</span><span class=p>:</span> <span class=mi>1588389279195</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;updated_at&#34;</span><span class=p>:</span> <span class=mi>1588400691047</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;deleted&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;2b130e52-079d-4b31-9f42-ce257cf546f0&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;comments&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;created&#34;</span><span class=p>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;updated&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;1e945c88-baf2-4db7-aa39-286b6865b3fb&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;comment&#34;</span><span class=p>:</span> <span class=s2>&#34;That&#39;s good!&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;deleted&#34;</span><span class=p>:</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><ul><li><code>created</code> and <code>updated</code> is an array of object containing created / updated records</li><li><code>deleted</code> is an array of string of deleted IDs</li></ul><h2 id=sync-flow class=headerLink><a href=#sync-flow class=header-mark></a>Sync Flow</h2><p>Based on the documentation and <a href=https://nozbe.github.io/WatermelonDB/Advanced/Sync.html#using-synchronize target=_blank rel="noopener noreferrer">sync code example (<code>synchronize()</code>) on client side</a>, this is what will be expected from sync backend:</p><p><a class=lightgallery href="https://www.plantuml.com/plantuml/proxy?src=https://raw.githubusercontent.com/fahrinh/my-blog/master/diagram/watermelondb-sync-flow.plantuml" title="WatermelonDB Sync Flow" data-thumbnail="https://www.plantuml.com/plantuml/proxy?src=https://raw.githubusercontent.com/fahrinh/my-blog/master/diagram/watermelondb-sync-flow.plantuml"><img class=lazyload data-src="https://www.plantuml.com/plantuml/proxy?src=https://raw.githubusercontent.com/fahrinh/my-blog/master/diagram/watermelondb-sync-flow.plantuml" data-srcset="https://www.plantuml.com/plantuml/proxy?src=https://raw.githubusercontent.com/fahrinh/my-blog/master/diagram/watermelondb-sync-flow.plantuml, https://www.plantuml.com/plantuml/proxy?src=https://raw.githubusercontent.com/fahrinh/my-blog/master/diagram/watermelondb-sync-flow.plantuml 1.5x, https://www.plantuml.com/plantuml/proxy?src=https://raw.githubusercontent.com/fahrinh/my-blog/master/diagram/watermelondb-sync-flow.plantuml 2x" data-sizes=auto alt="https://www.plantuml.com/plantuml/proxy?src=https://raw.githubusercontent.com/fahrinh/my-blog/master/diagram/watermelondb-sync-flow.plantuml"></a></p><h1 id=proposed-alternative-sync-approach class=headerLink><a href=#proposed-alternative-sync-approach class=header-mark></a>Proposed Alternative Sync Approach</h1><p>While in iterations of prototyping sync backend, I took another approach for tracking changes and made a workaround for an issue in regard to WatermelonDB sync behaviour on client side.</p><h2 id=using-auto-incrementing-counter-version--timestamp-for-tracking-changes class=headerLink><a href=#using-auto-incrementing-counter-version--timestamp-for-tracking-changes class=header-mark></a>Using Auto-incrementing Counter (Version) + Timestamp for Tracking Changes</h2><p>WatermelonDB sync documentation is good enough to gives a tips for implementing sync backend by using timestamp. It also states:</p><blockquote><p>This protects against weird edge cases related to server clock time changes (NTP time sync, leap seconds, etc.) (<strong>Alternatively, instead of using timestamps, you could use auto-incrementing couters, but you&rsquo;d have to ensure they are consistent across the whole database, not just one table</strong>)</p></blockquote><p>I followed its suggestion to use auto-incrementing counter. In my approach, for tracking changes, it needs these server DB setup: a global sequence (<code>version_seq</code>) & each table have columns: <code>version</code> (int), <code>version_created</code> (int), <code>created_at_server</code> (timestamp), <code>updated_at_server</code> (timestamp), and <code>deleted_at_server</code> (timestamp).</p><p>Please see Database Design to know how this is implemented in practice.</p><h2 id=workaround-for-sync-on-client-side class=headerLink><a href=#workaround-for-sync-on-client-side class=header-mark></a>Workaround for Sync on Client Side</h2><p>There is a problem if we use <a href=https://nozbe.github.io/WatermelonDB/Advanced/Sync.html#using-synchronize target=_blank rel="noopener noreferrer">sync code example (<code>synchronize()</code>) for client side on the documentation</a>.</p><p>Please look again at Sync Flow diagram above.</p><p>In <strong>8</strong>, after WatermelonDB receives <code>changes</code> & <code>timestamp</code>, internally, <code>timestamp</code> value is set as <code>lastPulledAt</code> for the next pull operation. That is not problem.</p><p>At first, I assume it will have same mechanism for push operation.
We got new <code>timestamp</code> that will be become the next <code>lastPulledAt</code>.
But I am wrong.
Look at <strong>15</strong>.
No response at all for push operation AND no way to explicitly set <code>lastPulledAt</code> on the push operation.
It means for the next pull operation, we will get changes that we&rsquo;ve just pushed on previous push operation. Well, it actually mentioned <a href=https://nozbe.github.io/WatermelonDB/Advanced/Sync.html#current-limitations target=_blank rel="noopener noreferrer">in the documentation</a>:</p><blockquote><p>Current limitations</p></blockquote><blockquote><ol start=2><li>During next sync pull, changes we&rsquo;ve just pushed will be pulled again, which is unnecessary. It would be better if server, during push, also pulled local changes since <code>lastPulledAt</code> and responded with NEW timestamp to be treated as <code>lastPulledAt</code>.</li></ol></blockquote><p>I don&rsquo;t know why this library designed to behave like this. It raised <a href=https://github.com/Nozbe/WatermelonDB/issues/649 target=_blank rel="noopener noreferrer">an issue complaining/questioning about that</a>.</p><h3 id=sync-flow-workaround class=headerLink><a href=#sync-flow-workaround class=header-mark></a>Sync Flow Workaround</h3><p>So this is what I did for a temporary solution/workaround:</p><p><a class=lightgallery href="https://www.plantuml.com/plantuml/proxy?src=https://raw.githubusercontent.com/fahrinh/my-blog/master/diagram/watermelondb-sync-flow-workaround.plantuml" title="WatermelonDB Sync Flow Workaround" data-thumbnail="https://www.plantuml.com/plantuml/proxy?src=https://raw.githubusercontent.com/fahrinh/my-blog/master/diagram/watermelondb-sync-flow-workaround.plantuml"><img class=lazyload data-src="https://www.plantuml.com/plantuml/proxy?src=https://raw.githubusercontent.com/fahrinh/my-blog/master/diagram/watermelondb-sync-flow-workaround.plantuml" data-srcset="https://www.plantuml.com/plantuml/proxy?src=https://raw.githubusercontent.com/fahrinh/my-blog/master/diagram/watermelondb-sync-flow-workaround.plantuml, https://www.plantuml.com/plantuml/proxy?src=https://raw.githubusercontent.com/fahrinh/my-blog/master/diagram/watermelondb-sync-flow-workaround.plantuml 1.5x, https://www.plantuml.com/plantuml/proxy?src=https://raw.githubusercontent.com/fahrinh/my-blog/master/diagram/watermelondb-sync-flow-workaround.plantuml 2x" data-sizes=auto alt="https://www.plantuml.com/plantuml/proxy?src=https://raw.githubusercontent.com/fahrinh/my-blog/master/diagram/watermelondb-sync-flow-workaround.plantuml"></a></p><ul><li>introduce variable <code>latestVersionOfSession</code> & <code>changesOfSession</code> (<strong>1</strong>)</li><li>call <code>synchronize()</code> twice (<strong>2</strong> & <strong>20</strong>)</li><li>on first <code>synchronize()</code>, pull & push operation retrieve <code>latestVersion</code> & <code>changes</code> (<strong>8</strong> & <strong>19</strong>) then set it as <code>latestVersionOfSession</code> & <code>changesOfSession</code> value</li><li>on second <code>synchronize()</code>, pull operation only set <code>lastPulledAt = latestVersionOfSession</code> & <code>changes = changesOfSession</code> to be applied on LocalDB (<strong>22</strong>). Push operation does nothing.</li></ul><p>This is workaround for the client side. The code is available on <a href=https://fahri.id/posts/building-an-offline-first-react-web-app-using-watermelondb-in-phoenix-elixir/ rel>the next post</a>.</p><h1 id=application-example-blogapp class=headerLink><a href=#application-example-blogapp class=header-mark></a>Application Example: BlogApp</h1><p>Let&rsquo;s say we want to build a blog app (web based) that supports data synchronization.
User can submit, edit, and delete a post content. If user click Sync button, data located on current browser will be synced to server. So if user open another browser (another client device), data will be automically synced and available on that browser.</p><p>This tutorial only covers how to build sync backend implementation. Frontend (ReactJS) implementation is available on the next post: <a href=https://fahri.id/posts/building-an-offline-first-react-web-app-using-watermelondb-in-phoenix-elixir/ rel>Building an Offline First React Web App Using WatermelonDB in Phoenix (Elixir)</a>.</p><h2 id=database-design class=headerLink><a href=#database-design class=header-mark></a>Database Design</h2><h2 id=determining-data-changes class=headerLink><a href=#determining-data-changes class=header-mark></a>Determining Data Changes</h2><p>For push operation:</p><ul><li>when a new data is created:<ul><li><code>version = nextval('version_seq')</code></li><li><code>version_created = nextval('version_seq')</code></li><li><code>created_at_server = current time</code></li><li><code>updated_at_server = current time</code></li></ul></li><li>when a data is updated:<ul><li><code>version = nextval('version_seq')</code></li><li><code>updated_at_server = current time</code></li></ul></li><li>when a data is deleted:<ul><li><code>version = nextval('version_seq')</code></li><li><code>deleted_at_server = current time</code></li></ul></li></ul><p>For pull operation:</p><ul><li><p>retrieve all data that were changed since <code>lastPulledVersion</code>:</p><p><code>SELECT * FROM posts WHERE version_created > &lt;lastPulledVersion> OR version > &lt;lastPulledVersion></code></p></li><li><p>Then categorize which records were created, updated, or deleted :</p><ul><li><p>created</p><p><code>version_created > &lt;lastPulledVersion> AND deleted_at_server IS NULL</code></p></li><li><p>updated</p><p><code>created_at_server != updated_at_server AND deleted_at_server IS NULL</code></p></li><li><p>deleted</p><p><code>deleted_at_server IS NOT NULL</code></p></li></ul></li></ul><h1 id=sync-backend-implementation class=headerLink><a href=#sync-backend-implementation class=header-mark></a>Sync Backend Implementation</h1><p>Sync Backend consists of four main components: <code>SyncController</code>, <code>Sync</code> context, <code>Blog</code> context, and <code>Repo</code>. If you come from another framework, <em>context</em> is kind of like <em>service</em>.</p><p><a class=lightgallery href="https://www.plantuml.com/plantuml/proxy?src=https://raw.githubusercontent.com/fahrinh/my-blog/master/diagram/blog-app-architecture.plantuml" title="BlogApp Architecture" data-thumbnail="https://www.plantuml.com/plantuml/proxy?src=https://raw.githubusercontent.com/fahrinh/my-blog/master/diagram/blog-app-architecture.plantuml"><img class=lazyload data-src="https://www.plantuml.com/plantuml/proxy?src=https://raw.githubusercontent.com/fahrinh/my-blog/master/diagram/blog-app-architecture.plantuml" data-srcset="https://www.plantuml.com/plantuml/proxy?src=https://raw.githubusercontent.com/fahrinh/my-blog/master/diagram/blog-app-architecture.plantuml, https://www.plantuml.com/plantuml/proxy?src=https://raw.githubusercontent.com/fahrinh/my-blog/master/diagram/blog-app-architecture.plantuml 1.5x, https://www.plantuml.com/plantuml/proxy?src=https://raw.githubusercontent.com/fahrinh/my-blog/master/diagram/blog-app-architecture.plantuml 2x" data-sizes=auto alt="https://www.plantuml.com/plantuml/proxy?src=https://raw.githubusercontent.com/fahrinh/my-blog/master/diagram/blog-app-architecture.plantuml"></a></p><p>We will build sync backend using Elixir 1.10 and Phoenix 1.5.1</p><p>Install Phoenix 1.5.1:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ mix archive.uninstall phx_new
</span></span><span class=line><span class=cl>$ mix archive.install hex phx_new 1.5.1
</span></span></code></pre></div><p>Generate a new Phoenix web app:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ mix phx.new blog_app
</span></span></code></pre></div><p>We will use PostgreSQL on Docker with password and database name specified on <code>config/dev.exs</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ docker run --name blog-db -e <span class=nv>POSTGRES_PASSWORD</span><span class=o>=</span>postgres -e <span class=nv>POSTGRES_DB</span><span class=o>=</span>blog_app_dev -d -p 5432:5432 postgres:12.2
</span></span></code></pre></div><p>Create the database:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ <span class=nb>cd</span> blog_app
</span></span><span class=line><span class=cl>$ mix ecto.create
</span></span></code></pre></div><p>Create <code>version_seq</code> sequence that will generate version for each data changes :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ mix ecto.gen.migration create_version_seq
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-elixir data-lang=elixir><span class=line><span class=cl><span class=c1># priv/repo/migrations/xxx_create_version_seq.exs</span>
</span></span><span class=line><span class=cl><span class=kd>defmodule</span> <span class=nc>BlogApp.Repo.Migrations.CreateVersionSeq</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>  <span class=kn>use</span> <span class=nc>Ecto.Migration</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>def</span> <span class=n>change</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=n>execute</span> <span class=s2>&#34;CREATE SEQUENCE version_seq&#34;</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ mix ecto.migrate
</span></span></code></pre></div><p>Generate <code>Post</code> schema:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ mix phx.gen.schema Blog.Post posts title:string content:string likes:integer push_id:integer created_at:utc_datetime_usec updated_at:utc_datetime_usec created_at_server:utc_datetime_usec updated_at_server:utc_datetime_usec deleted_at_server:utc_datetime_usec version:integer version_created:integer --binary-id
</span></span></code></pre></div><p>Set default value of <code>version*</code> columns with a incremental number generated by <code>version_seq</code>.
As it may increase overtime, change <code>version*</code> columns type to <code>bigint</code> to support bigger value.
We don&rsquo;t need <code>inserted_at</code> and <code>updated_at</code> columns generated by Phoenix so we omit <code>timestamps()</code>.
Edit <code>xxx_create_posts.exs</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=line><span class=cl># priv/repo/migrations/xxx_create_posts.exs
</span></span><span class=line><span class=cl>defmodule BlogApp.Repo.Migrations.CreatePosts do
</span></span><span class=line><span class=cl>  use Ecto.Migration
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  def change do
</span></span><span class=line><span class=cl>    create table(:posts, primary_key: false) do
</span></span><span class=line><span class=cl>      add :id, :binary_id, primary_key: true
</span></span><span class=line><span class=cl>      add :title, :string
</span></span><span class=line><span class=cl>      add :content, :string
</span></span><span class=line><span class=cl>      add :likes, :integer
</span></span><span class=line><span class=cl>      add :created_at, :utc_datetime_usec
</span></span><span class=line><span class=cl>      add :updated_at, :utc_datetime_usec
</span></span><span class=line><span class=cl>      add :created_at_server, :utc_datetime_usec
</span></span><span class=line><span class=cl>      add :updated_at_server, :utc_datetime_usec
</span></span><span class=line><span class=cl>      add :deleted_at_server, :utc_datetime_usec
</span></span><span class=line><span class=cl>      add :push_id, :integer
</span></span><span class=line><span class=cl><span class=gd>-     add :version, :integer
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+     add :version, :bigint, default: fragment(&#34;nextval(&#39;version_seq&#39;)&#34;)
</span></span></span><span class=line><span class=cl><span class=gi></span><span class=gd>-     add :version_created, :integer
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+     add :version_created, :bigint, default: fragment(&#34;nextval(&#39;version_seq&#39;)&#34;)
</span></span></span><span class=line><span class=cl><span class=gi></span>
</span></span><span class=line><span class=cl><span class=gd>-     timestamps()
</span></span></span><span class=line><span class=cl><span class=gd></span>    end
</span></span><span class=line><span class=cl>  end
</span></span><span class=line><span class=cl>end
</span></span></code></pre></div><p>To enable JSON encoding for <code>Post</code> schema, annotate it with <code>@derive</code> <code>Jason.Encoder</code> for certain columns only:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=line><span class=cl># lib/blog_app/blog/post.ex
</span></span><span class=line><span class=cl>defmodule BlogApp.Blog.Post do
</span></span><span class=line><span class=cl>  use Ecto.Schema
</span></span><span class=line><span class=cl>  import Ecto.Changeset
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  @primary_key {:id, :binary_id, autogenerate: true}
</span></span><span class=line><span class=cl>  @foreign_key_type :binary_id
</span></span><span class=line><span class=cl><span class=gi>+ @derive {Jason.Encoder, only: [:id, :title, :content, :likes]}
</span></span></span><span class=line><span class=cl><span class=gi></span>  schema &#34;posts&#34; do
</span></span><span class=line><span class=cl>    field :title, :string
</span></span><span class=line><span class=cl>    field :content, :string
</span></span><span class=line><span class=cl>    field :likes, :integer
</span></span><span class=line><span class=cl>    field :created_at, :utc_datetime_usec
</span></span><span class=line><span class=cl>    field :updated_at, :utc_datetime_usec
</span></span><span class=line><span class=cl>    field :created_at_server, :utc_datetime_usec
</span></span><span class=line><span class=cl>    field :updated_at_server, :utc_datetime_usec
</span></span><span class=line><span class=cl>    field :deleted_at_server, :utc_datetime_usec
</span></span><span class=line><span class=cl>    field :push_id, :integer
</span></span><span class=line><span class=cl>    field :version, :integer
</span></span><span class=line><span class=cl>    field :version_created, :integer
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=gd>-   timestamps()
</span></span></span><span class=line><span class=cl><span class=gd></span>  end
</span></span><span class=line><span class=cl>  # ...
</span></span><span class=line><span class=cl>end
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ mix ecto.migrate
</span></span></code></pre></div><h2 id=sync-endpoint class=headerLink><a href=#sync-endpoint class=header-mark></a>Sync Endpoint</h2><p>Sync endpoint will be handled by:</p><ul><li>push: <code>POST /api/sync/push?lastPulledVersion=&lt;lastPulledVersion></code></li><li>pull: <code>GET /api/sync/pull?lastPulledVersion=&lt;lastPulledVersion></code></li></ul><p>Edit <code>lib/blog_app_web/router.ex</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-elixir data-lang=elixir><span class=line><span class=cl><span class=c1># lib/blog_app_web/router.ex</span>
</span></span><span class=line><span class=cl><span class=kd>defmodule</span> <span class=nc>BlogAppWeb.Router</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=c1># ...</span>
</span></span><span class=line><span class=cl>    <span class=n>scope</span> <span class=s2>&#34;/api&#34;</span><span class=p>,</span> <span class=nc>BlogAppWeb</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>      <span class=n>pipe_through</span> <span class=ss>:api</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=n>post</span> <span class=s2>&#34;/sync/push&#34;</span><span class=p>,</span> <span class=nc>SyncController</span><span class=p>,</span> <span class=ss>:push</span>
</span></span><span class=line><span class=cl>      <span class=n>get</span> <span class=s2>&#34;/sync/pull&#34;</span><span class=p>,</span> <span class=nc>SyncController</span><span class=p>,</span> <span class=ss>:pull</span>
</span></span><span class=line><span class=cl>    <span class=k>end</span>
</span></span><span class=line><span class=cl>    <span class=c1># ...</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></div><h3 id=controller class=headerLink><a href=#controller class=header-mark></a>Controller</h3><p>Create <code>lib/blog_app_web/controllers/sync_controller.ex</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-elixir data-lang=elixir><span class=line><span class=cl><span class=c1># lib/blog_app_web/controllers/sync_controller.ex</span>
</span></span><span class=line><span class=cl><span class=kd>defmodule</span> <span class=nc>BlogAppWeb.SyncController</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>  <span class=kn>use</span> <span class=nc>BlogAppWeb</span><span class=p>,</span> <span class=ss>:controller</span>
</span></span><span class=line><span class=cl>  <span class=kn>alias</span> <span class=nc>BlogApp.Sync</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>def</span> <span class=n>push</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=p>%</span><span class=nc>Plug.Conn</span><span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=ss>body_params</span><span class=p>:</span> <span class=n>req_body</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=ss>query_params</span><span class=p>:</span> <span class=p>%{</span><span class=s2>&#34;lastPulledVersion&#34;</span> <span class=o>=&gt;</span> <span class=n>last_pulled_version</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=o>=</span> <span class=n>conn</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>_params</span>
</span></span><span class=line><span class=cl>      <span class=p>)</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>resp</span> <span class=o>=</span>  <span class=nc>Sync</span><span class=o>.</span><span class=n>push</span><span class=p>(</span><span class=n>req_body</span><span class=p>,</span> <span class=nc>String</span><span class=o>.</span><span class=n>to_integer</span><span class=p>(</span><span class=n>last_pulled_version</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>json</span><span class=p>(</span><span class=n>conn</span><span class=p>,</span> <span class=n>resp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>def</span> <span class=n>pull</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=p>%</span><span class=nc>Plug.Conn</span><span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=ss>query_params</span><span class=p>:</span> <span class=p>%{</span><span class=s2>&#34;lastPulledVersion&#34;</span> <span class=o>=&gt;</span> <span class=n>last_pulled_version</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=o>=</span> <span class=n>conn</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>_params</span>
</span></span><span class=line><span class=cl>      <span class=p>)</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>resp</span> <span class=o>=</span> <span class=nc>Sync</span><span class=o>.</span><span class=n>pull</span><span class=p>(</span><span class=nc>String</span><span class=o>.</span><span class=n>to_integer</span><span class=p>(</span><span class=n>last_pulled_version</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>json</span><span class=p>(</span><span class=n>conn</span><span class=p>,</span> <span class=n>resp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></div><h2 id=push class=headerLink><a href=#push class=header-mark></a>Push</h2><p>Changes have to be recorded in a DB transaction.
If there is a failed data operation, every operation must be rolled back.</p><p>In a push operation, data that will be recorded are also annotated with a <code>push_id</code>.
Later on, after push operation has been successfully applied, all changes since <code>last_pulled_version</code> are retrieved to become push response except those have already been applied (filtered with <code>push_id</code>).</p><p><code>BlogApp.Sync.push/2</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-elixir data-lang=elixir><span class=line><span class=cl><span class=c1># lib/blog_app/sync.ex</span>
</span></span><span class=line><span class=cl><span class=kd>defmodule</span> <span class=nc>BlogApp.Sync</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>  <span class=kn>alias</span> <span class=nc>BlogApp</span><span class=o>.</span><span class=p>{</span><span class=nc>Repo</span><span class=p>,</span> <span class=nc>Blog</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>def</span> <span class=n>push</span><span class=p>(</span><span class=n>changes</span><span class=p>,</span> <span class=n>last_pulled_version</span><span class=p>)</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=n>push_id</span> <span class=o>=</span> <span class=nc>Enum</span><span class=o>.</span><span class=n>random</span><span class=p>(</span><span class=mi>1</span><span class=o>..</span><span class=mi>1_000_000_000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nc>Ecto.Multi</span><span class=o>.</span><span class=n>new</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=o>|&gt;</span> <span class=nc>Blog</span><span class=o>.</span><span class=n>record_posts</span><span class=p>(</span><span class=n>changes</span><span class=p>[</span><span class=s2>&#34;posts&#34;</span><span class=p>],</span> <span class=n>last_pulled_version</span><span class=p>,</span> <span class=n>push_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>|&gt;</span> <span class=nc>Repo</span><span class=o>.</span><span class=n>transaction</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>pull</span><span class=p>(</span><span class=n>last_pulled_version</span><span class=p>,</span> <span class=n>push_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl>  <span class=c1># ...</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></div><p><code>BlogApp.Blog.record_posts/4</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-elixir data-lang=elixir><span class=line><span class=cl><span class=c1># lib/blog_app/blog.ex</span>
</span></span><span class=line><span class=cl><span class=kd>defmodule</span> <span class=nc>BlogApp.Blog</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>  <span class=kn>import</span> <span class=nc>Ecto.Query</span>
</span></span><span class=line><span class=cl>  <span class=kn>alias</span> <span class=nc>Ecto.Multi</span>
</span></span><span class=line><span class=cl>  <span class=kn>alias</span> <span class=nc>BlogApp.Repo</span>
</span></span><span class=line><span class=cl>  <span class=kn>alias</span> <span class=nc>BlogApp.Blog.Post</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>def</span> <span class=n>record_posts</span><span class=p>(%</span><span class=nc>Multi</span><span class=p>{}</span> <span class=o>=</span> <span class=n>multi</span><span class=p>,</span> <span class=n>post_changes</span><span class=p>,</span> <span class=n>last_pulled_version</span><span class=p>,</span> <span class=n>push_id</span><span class=p>)</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=n>multi</span>
</span></span><span class=line><span class=cl>    <span class=o>|&gt;</span> <span class=nc>Multi</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=ss>:check_conflict_posts</span><span class=p>,</span> <span class=k>fn</span> <span class=n>_</span><span class=p>,</span> <span class=n>_changes</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=n>check_conflict_version_posts</span><span class=p>(</span><span class=n>post_changes</span><span class=p>,</span> <span class=n>last_pulled_version</span><span class=p>)</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>        <span class=ss>:no_conflict</span> <span class=o>-&gt;</span> <span class=p>{</span><span class=ss>:ok</span><span class=p>,</span> <span class=ss>:no_conflict</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=ss>:conflict</span> <span class=o>-&gt;</span> <span class=p>{</span><span class=ss>:error</span><span class=p>,</span> <span class=ss>:conflict</span><span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>end</span>
</span></span><span class=line><span class=cl>    <span class=k>end</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>|&gt;</span> <span class=n>record_created_posts</span><span class=p>(</span><span class=n>post_changes</span><span class=p>[</span><span class=s2>&#34;created&#34;</span><span class=p>]</span> <span class=o>|&gt;</span> <span class=n>set_push_id</span><span class=p>(</span><span class=n>push_id</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=o>|&gt;</span> <span class=n>record_updated_posts</span><span class=p>(</span><span class=n>post_changes</span><span class=p>[</span><span class=s2>&#34;updated&#34;</span><span class=p>]</span> <span class=o>|&gt;</span> <span class=n>set_push_id</span><span class=p>(</span><span class=n>push_id</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=o>|&gt;</span> <span class=n>record_deleted_posts</span><span class=p>(</span><span class=n>post_changes</span><span class=p>[</span><span class=s2>&#34;deleted&#34;</span><span class=p>],</span> <span class=n>push_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl>  <span class=c1># ...</span>
</span></span><span class=line><span class=cl>  <span class=kd>defp</span> <span class=n>set_push_id</span><span class=p>(</span><span class=n>posts</span><span class=p>,</span> <span class=n>push_id</span><span class=p>)</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=n>posts</span>
</span></span><span class=line><span class=cl>    <span class=o>|&gt;</span> <span class=nc>Enum</span><span class=o>.</span><span class=n>map</span><span class=p>(</span><span class=k>fn</span> <span class=n>post</span> <span class=o>-&gt;</span> <span class=n>post</span> <span class=o>|&gt;</span> <span class=nc>Map</span><span class=o>.</span><span class=n>put</span><span class=p>(</span><span class=s2>&#34;push_id&#34;</span><span class=p>,</span> <span class=n>push_id</span><span class=p>)</span> <span class=k>end</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl>  <span class=c1># ...</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></div><h3 id=conflict-detection class=headerLink><a href=#conflict-detection class=header-mark></a>Conflict Detection</h3><p>Conflict happens when other users/clients have modified data that we&rsquo;re pushing.</p><p><code>Blog.check_conflict_version_posts/2</code> :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-elixir data-lang=elixir><span class=line><span class=cl><span class=c1># lib/blog_app/blog.ex</span>
</span></span><span class=line><span class=cl><span class=kd>defmodule</span> <span class=nc>BlogApp.Blog</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>  <span class=c1># ...</span>
</span></span><span class=line><span class=cl>  <span class=kd>def</span> <span class=n>check_conflict_version_posts</span><span class=p>(</span><span class=n>post_changes</span><span class=p>,</span> <span class=n>last_pulled_version</span><span class=p>)</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=n>ids</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=nc>Enum</span><span class=o>.</span><span class=n>concat</span><span class=p>(</span><span class=n>post_changes</span><span class=p>[</span><span class=s2>&#34;created&#34;</span><span class=p>],</span> <span class=n>post_changes</span><span class=p>[</span><span class=s2>&#34;updated&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>      <span class=o>|&gt;</span> <span class=nc>Enum</span><span class=o>.</span><span class=n>map</span><span class=p>(</span><span class=k>fn</span> <span class=n>post</span> <span class=o>-&gt;</span> <span class=n>post</span><span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>]</span> <span class=k>end</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=o>|&gt;</span> <span class=nc>Enum</span><span class=o>.</span><span class=n>concat</span><span class=p>(</span><span class=n>post_changes</span><span class=p>[</span><span class=s2>&#34;deleted&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>count</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=nc>Post</span>
</span></span><span class=line><span class=cl>      <span class=o>|&gt;</span> <span class=n>select</span><span class=p>([</span><span class=n>p</span><span class=p>],</span> <span class=n>count</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>version</span><span class=p>))</span>
</span></span><span class=line><span class=cl>      <span class=o>|&gt;</span> <span class=n>where</span><span class=p>([</span><span class=n>p</span><span class=p>],</span> <span class=n>p</span><span class=o>.</span><span class=n>id</span> <span class=ow>in</span> <span class=o>^</span><span class=n>ids</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=o>|&gt;</span> <span class=n>where</span><span class=p>([</span><span class=n>p</span><span class=p>],</span> <span class=n>p</span><span class=o>.</span><span class=n>version</span> <span class=o>&gt;</span> <span class=o>^</span><span class=n>last_pulled_version</span> <span class=ow>or</span> <span class=n>p</span><span class=o>.</span><span class=n>version_created</span> <span class=o>&gt;</span> <span class=o>^</span><span class=n>last_pulled_version</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=o>|&gt;</span> <span class=nc>Repo</span><span class=o>.</span><span class=n>one</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=n>count</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>      <span class=mi>0</span> <span class=o>-&gt;</span> <span class=ss>:no_conflict</span>
</span></span><span class=line><span class=cl>      <span class=n>_</span> <span class=o>-&gt;</span> <span class=ss>:conflict</span>
</span></span><span class=line><span class=cl>    <span class=k>end</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl>  <span class=c1># ...</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></div><h3 id=storing-record-changes class=headerLink><a href=#storing-record-changes class=header-mark></a>Storing Record Changes</h3><p>Data changes are saved on database in bulk using <code>INSERT INTO CONFLICT</code> on PostgreSQL.
This is also known as UPSERT (update or insert).</p><p><code>Blog.upsert_posts/3</code> handle both create & update case.
<code>Blog.record_created_posts/2</code> & <code>Blog.record_updated_posts/2</code> :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-elixir data-lang=elixir><span class=line><span class=cl><span class=c1># lib/blog_app/blog.ex</span>
</span></span><span class=line><span class=cl><span class=kd>defmodule</span> <span class=nc>BlogApp.Blog</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>  <span class=c1># ...</span>
</span></span><span class=line><span class=cl>  <span class=kd>def</span> <span class=n>record_created_posts</span><span class=p>(%</span><span class=nc>Multi</span><span class=p>{}</span> <span class=o>=</span> <span class=n>multi</span><span class=p>,</span> <span class=n>created_changes</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=ss>do</span><span class=p>:</span> <span class=n>upsert_posts</span><span class=p>(</span><span class=n>multi</span><span class=p>,</span> <span class=ss>:create_posts</span><span class=p>,</span> <span class=n>created_changes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>def</span> <span class=n>record_updated_posts</span><span class=p>(%</span><span class=nc>Multi</span><span class=p>{}</span> <span class=o>=</span> <span class=n>multi</span><span class=p>,</span> <span class=n>updated_changes</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=ss>do</span><span class=p>:</span> <span class=n>upsert_posts</span><span class=p>(</span><span class=n>multi</span><span class=p>,</span> <span class=ss>:update_posts</span><span class=p>,</span> <span class=n>updated_changes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>def</span> <span class=n>upsert_posts</span><span class=p>(%</span><span class=nc>Multi</span><span class=p>{}</span> <span class=o>=</span> <span class=n>multi</span><span class=p>,</span> <span class=n>_name</span><span class=p>,</span> <span class=n>changes</span><span class=p>)</span> <span class=ow>when</span> <span class=n>is_nil</span><span class=p>(</span><span class=n>changes</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=ss>do</span><span class=p>:</span> <span class=n>multi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>def</span> <span class=n>upsert_posts</span><span class=p>(%</span><span class=nc>Multi</span><span class=p>{}</span> <span class=o>=</span> <span class=n>multi</span><span class=p>,</span> <span class=n>name</span><span class=p>,</span> <span class=n>changes</span><span class=p>)</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=n>now</span> <span class=o>=</span> <span class=nc>DateTime</span><span class=o>.</span><span class=n>utc_now</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>posts</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=n>changes</span>
</span></span><span class=line><span class=cl>      <span class=o>|&gt;</span> <span class=nc>Enum</span><span class=o>.</span><span class=n>map</span><span class=p>(</span><span class=k>fn</span> <span class=n>row</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>        <span class=n>row</span>
</span></span><span class=line><span class=cl>        <span class=o>|&gt;</span> <span class=nc>Map</span><span class=o>.</span><span class=n>put</span><span class=p>(</span><span class=s2>&#34;created_at&#34;</span><span class=p>,</span> <span class=n>row</span><span class=p>[</span><span class=s2>&#34;created_at&#34;</span><span class=p>]</span> <span class=o>*</span> <span class=mi>1000</span> <span class=o>|&gt;</span> <span class=nc>DateTime</span><span class=o>.</span><span class=n>from_unix!</span><span class=p>(</span><span class=ss>:microsecond</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=o>|&gt;</span> <span class=nc>Map</span><span class=o>.</span><span class=n>put</span><span class=p>(</span><span class=s2>&#34;updated_at&#34;</span><span class=p>,</span> <span class=n>row</span><span class=p>[</span><span class=s2>&#34;updated_at&#34;</span><span class=p>]</span> <span class=o>*</span> <span class=mi>1000</span> <span class=o>|&gt;</span> <span class=nc>DateTime</span><span class=o>.</span><span class=n>from_unix!</span><span class=p>(</span><span class=ss>:microsecond</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=o>|&gt;</span> <span class=nc>Map</span><span class=o>.</span><span class=n>put</span><span class=p>(</span><span class=s2>&#34;created_at_server&#34;</span><span class=p>,</span> <span class=n>now</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=o>|&gt;</span> <span class=nc>Map</span><span class=o>.</span><span class=n>put</span><span class=p>(</span><span class=s2>&#34;updated_at_server&#34;</span><span class=p>,</span> <span class=n>now</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=o>|&gt;</span> <span class=nc>Map</span><span class=o>.</span><span class=n>take</span><span class=p>([</span><span class=s2>&#34;id&#34;</span><span class=p>,</span> <span class=s2>&#34;title&#34;</span><span class=p>,</span> <span class=s2>&#34;content&#34;</span><span class=p>,</span> <span class=s2>&#34;likes&#34;</span><span class=p>,</span> <span class=s2>&#34;created_at&#34;</span><span class=p>,</span> <span class=s2>&#34;updated_at&#34;</span><span class=p>,</span> <span class=s2>&#34;created_at_server&#34;</span><span class=p>,</span> <span class=s2>&#34;updated_at_server&#34;</span><span class=p>,</span> <span class=s2>&#34;push_id&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=o>|&gt;</span> <span class=n>key_to_atom</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=k>end</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nc>Multi</span><span class=o>.</span><span class=n>insert_all</span><span class=p>(</span><span class=n>multi</span><span class=p>,</span> <span class=n>name</span><span class=p>,</span> <span class=nc>Post</span><span class=p>,</span> <span class=n>posts</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=ss>conflict_target</span><span class=p>:</span> <span class=ss>:id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=ss>on_conflict</span><span class=p>:</span> <span class=p>{</span><span class=ss>:replace_all_except</span><span class=p>,</span> <span class=p>[</span><span class=ss>:id</span><span class=p>,</span> <span class=ss>:version_created</span><span class=p>,</span> <span class=ss>:created_at_server</span><span class=p>,</span> <span class=ss>:deleted_at_server</span><span class=p>]},</span>
</span></span><span class=line><span class=cl>      <span class=ss>returning</span><span class=p>:</span> <span class=no>true</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>def</span> <span class=n>key_to_atom</span><span class=p>(</span><span class=n>map</span><span class=p>)</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=nc>Enum</span><span class=o>.</span><span class=n>reduce</span><span class=p>(</span><span class=n>map</span><span class=p>,</span> <span class=p>%{},</span> <span class=k>fn</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span><span class=n>key</span><span class=p>,</span> <span class=n>value</span><span class=p>},</span> <span class=n>acc</span> <span class=ow>when</span> <span class=n>is_atom</span><span class=p>(</span><span class=n>key</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nc>Map</span><span class=o>.</span><span class=n>put</span><span class=p>(</span><span class=n>acc</span><span class=p>,</span> <span class=n>key</span><span class=p>,</span> <span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span><span class=n>key</span><span class=p>,</span> <span class=n>value</span><span class=p>},</span> <span class=n>acc</span> <span class=ow>when</span> <span class=n>is_binary</span><span class=p>(</span><span class=n>key</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nc>Map</span><span class=o>.</span><span class=n>put</span><span class=p>(</span><span class=n>acc</span><span class=p>,</span> <span class=nc>String</span><span class=o>.</span><span class=n>to_existing_atom</span><span class=p>(</span><span class=n>key</span><span class=p>),</span> <span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>end</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl>  <span class=c1># ...</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></div><p><code>Blog.record_deleted_posts/3</code> :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-elixir data-lang=elixir><span class=line><span class=cl><span class=c1># lib/blog_app/blog.ex</span>
</span></span><span class=line><span class=cl><span class=kd>defmodule</span> <span class=nc>BlogApp.Blog</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>  <span class=c1># ...</span>
</span></span><span class=line><span class=cl>  <span class=kd>def</span> <span class=n>record_deleted_posts</span><span class=p>(%</span><span class=nc>Multi</span><span class=p>{}</span> <span class=o>=</span> <span class=n>multi</span><span class=p>,</span> <span class=n>deleted_ids</span><span class=p>,</span> <span class=n>_push_id</span><span class=p>)</span> <span class=ow>when</span> <span class=n>is_nil</span><span class=p>(</span><span class=n>deleted_ids</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=ss>do</span><span class=p>:</span> <span class=n>multi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>def</span> <span class=n>record_deleted_posts</span><span class=p>(%</span><span class=nc>Multi</span><span class=p>{}</span> <span class=o>=</span> <span class=n>multi</span><span class=p>,</span> <span class=n>deleted_ids</span><span class=p>,</span> <span class=n>push_id</span><span class=p>)</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=n>now</span> <span class=o>=</span> <span class=nc>DateTime</span><span class=o>.</span><span class=n>utc_now</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>posts</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=n>deleted_ids</span>
</span></span><span class=line><span class=cl>      <span class=o>|&gt;</span> <span class=nc>Enum</span><span class=o>.</span><span class=n>map</span><span class=p>(</span><span class=k>fn</span> <span class=n>id</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>%{</span><span class=ss>id</span><span class=p>:</span> <span class=n>id</span><span class=p>,</span> <span class=ss>deleted_at_server</span><span class=p>:</span> <span class=n>now</span><span class=p>,</span> <span class=ss>push_id</span><span class=p>:</span> <span class=n>push_id</span><span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>end</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nc>Multi</span><span class=o>.</span><span class=n>insert_all</span><span class=p>(</span><span class=n>multi</span><span class=p>,</span> <span class=ss>:delete_posts</span><span class=p>,</span> <span class=nc>Post</span><span class=p>,</span> <span class=n>posts</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=ss>conflict_target</span><span class=p>:</span> <span class=ss>:id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=ss>on_conflict</span><span class=p>:</span> <span class=p>{</span><span class=ss>:replace</span><span class=p>,</span> <span class=p>[</span><span class=ss>:deleted_at_server</span><span class=p>,</span> <span class=ss>:version</span><span class=p>,</span> <span class=ss>:push_id</span><span class=p>]},</span>
</span></span><span class=line><span class=cl>      <span class=ss>returning</span><span class=p>:</span> <span class=no>true</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl>  <span class=c1># ...</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></div><h2 id=pull class=headerLink><a href=#pull class=header-mark></a>Pull</h2><p>Pull endpoint calls <code>Sync.pull</code> without <code>push_id</code> specified.
It means all data changes since <code>last_pulled_version</code> become the response of pull operation.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-elixir data-lang=elixir><span class=line><span class=cl><span class=c1># lib/blog_app/sync.ex</span>
</span></span><span class=line><span class=cl><span class=kd>defmodule</span> <span class=nc>BlogApp.Sync</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>  <span class=c1># ...</span>
</span></span><span class=line><span class=cl>  <span class=kd>def</span> <span class=n>pull</span><span class=p>(</span><span class=n>last_pulled_version</span><span class=p>,</span> <span class=n>push_id</span> <span class=p>\\</span> <span class=no>nil</span><span class=p>)</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=p>%{</span><span class=ss>latest_version</span><span class=p>:</span> <span class=n>latest_version_posts</span><span class=p>,</span> <span class=ss>changes</span><span class=p>:</span> <span class=n>posts_changes</span><span class=p>}</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=nc>Blog</span><span class=o>.</span><span class=n>list_posts_changes</span><span class=p>(</span><span class=n>last_pulled_version</span><span class=p>,</span> <span class=n>push_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>latest_version</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=p>[</span><span class=n>last_pulled_version</span><span class=p>,</span> <span class=n>latest_version_posts</span><span class=p>]</span>
</span></span><span class=line><span class=cl>      <span class=o>|&gt;</span> <span class=nc>Enum</span><span class=o>.</span><span class=n>max</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=p>%{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;latestVersion&#34;</span> <span class=o>=&gt;</span> <span class=n>latest_version</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;changes&#34;</span> <span class=o>=&gt;</span> <span class=p>%{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;posts&#34;</span> <span class=o>=&gt;</span> <span class=n>posts_changes</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></div><p><code>Blog.list_posts_changes/2</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-elixir data-lang=elixir><span class=line><span class=cl><span class=c1># lib/blog_app/blog.ex</span>
</span></span><span class=line><span class=cl><span class=kd>defmodule</span> <span class=nc>BlogApp.Blog</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>  <span class=c1># ...</span>
</span></span><span class=line><span class=cl>  <span class=kd>def</span> <span class=n>list_posts_changes</span><span class=p>(</span><span class=n>last_pulled_version</span><span class=p>,</span> <span class=n>push_id</span><span class=p>)</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=n>posts_latest</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=nc>Post</span>
</span></span><span class=line><span class=cl>      <span class=o>|&gt;</span> <span class=n>where</span><span class=p>([</span><span class=n>p</span><span class=p>],</span> <span class=n>p</span><span class=o>.</span><span class=n>version_created</span> <span class=o>&gt;</span> <span class=o>^</span><span class=n>last_pulled_version</span> <span class=ow>or</span> <span class=n>p</span><span class=o>.</span><span class=n>version</span> <span class=o>&gt;</span> <span class=o>^</span><span class=n>last_pulled_version</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=o>|&gt;</span> <span class=nc>Repo</span><span class=o>.</span><span class=n>all</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>posts_changes</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=n>posts_latest</span>
</span></span><span class=line><span class=cl>      <span class=o>|&gt;</span> <span class=nc>Enum</span><span class=o>.</span><span class=n>reject</span><span class=p>(</span><span class=k>fn</span> <span class=n>post</span> <span class=o>-&gt;</span> <span class=n>is_just_pushed</span><span class=p>(</span><span class=n>post</span><span class=p>,</span> <span class=n>push_id</span><span class=p>)</span> <span class=k>end</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=o>|&gt;</span> <span class=nc>Enum</span><span class=o>.</span><span class=n>group_by</span><span class=p>(</span><span class=k>fn</span> <span class=n>post</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>        <span class=k>cond</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>          <span class=n>post</span><span class=o>.</span><span class=n>version_created</span> <span class=o>&gt;</span> <span class=n>last_pulled_version</span> <span class=ow>and</span> <span class=n>is_nil</span><span class=p>(</span><span class=n>post</span><span class=o>.</span><span class=n>deleted_at_server</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=ss>:created</span>
</span></span><span class=line><span class=cl>          <span class=n>post</span><span class=o>.</span><span class=n>created_at_server</span> <span class=o>!=</span> <span class=n>post</span><span class=o>.</span><span class=n>updated_at_server</span> <span class=ow>and</span> <span class=n>is_nil</span><span class=p>(</span><span class=n>post</span><span class=o>.</span><span class=n>deleted_at_server</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=ss>:updated</span>
</span></span><span class=line><span class=cl>          <span class=ow>not</span> <span class=n>is_nil</span><span class=p>(</span><span class=n>post</span><span class=o>.</span><span class=n>deleted_at_server</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=ss>:deleted</span>
</span></span><span class=line><span class=cl>        <span class=k>end</span>
</span></span><span class=line><span class=cl>      <span class=k>end</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=o>|&gt;</span> <span class=nc>Map</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=ss>:created</span><span class=p>,</span> <span class=p>[],</span> <span class=k>fn</span> <span class=n>posts</span> <span class=o>-&gt;</span> <span class=n>posts</span> <span class=k>end</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=o>|&gt;</span> <span class=nc>Map</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=ss>:updated</span><span class=p>,</span> <span class=p>[],</span> <span class=k>fn</span> <span class=n>posts</span> <span class=o>-&gt;</span> <span class=n>posts</span> <span class=k>end</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=o>|&gt;</span> <span class=nc>Map</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=ss>:deleted</span><span class=p>,</span> <span class=p>[],</span> <span class=k>fn</span> <span class=n>posts</span> <span class=o>-&gt;</span> <span class=n>posts</span> <span class=o>|&gt;</span> <span class=nc>Enum</span><span class=o>.</span><span class=n>map</span><span class=p>(</span><span class=k>fn</span> <span class=n>post</span> <span class=o>-&gt;</span> <span class=n>post</span><span class=o>.</span><span class=n>id</span> <span class=k>end</span><span class=p>)</span> <span class=k>end</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>latest_version</span> <span class=o>=</span> <span class=n>find_latest_version</span><span class=p>(</span><span class=n>posts_latest</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=p>%{</span><span class=ss>latest_version</span><span class=p>:</span> <span class=n>latest_version</span><span class=p>,</span> <span class=ss>changes</span><span class=p>:</span> <span class=n>posts_changes</span><span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>defp</span> <span class=n>find_latest_version</span><span class=p>(</span><span class=n>posts</span><span class=p>)</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=n>posts</span>
</span></span><span class=line><span class=cl>    <span class=o>|&gt;</span> <span class=nc>Enum</span><span class=o>.</span><span class=n>flat_map</span><span class=p>(</span><span class=k>fn</span> <span class=n>post</span> <span class=o>-&gt;</span> <span class=p>[</span><span class=n>post</span><span class=o>.</span><span class=n>version</span><span class=p>,</span> <span class=n>post</span><span class=o>.</span><span class=n>version_created</span><span class=p>]</span> <span class=k>end</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>|&gt;</span> <span class=nc>Enum</span><span class=o>.</span><span class=n>max</span><span class=p>(</span><span class=k>fn</span> <span class=o>-&gt;</span> <span class=mi>0</span> <span class=k>end</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl>  <span class=c1># ...</span>
</span></span><span class=line><span class=cl>  <span class=kd>defp</span> <span class=n>is_just_pushed</span><span class=p>(</span><span class=n>_post</span><span class=p>,</span> <span class=n>push_id</span><span class=p>)</span> <span class=ow>when</span> <span class=n>is_nil</span><span class=p>(</span><span class=n>push_id</span><span class=p>),</span> <span class=ss>do</span><span class=p>:</span> <span class=no>false</span>
</span></span><span class=line><span class=cl>  <span class=kd>defp</span> <span class=n>is_just_pushed</span><span class=p>(</span><span class=n>post</span><span class=p>,</span> <span class=n>push_id</span><span class=p>),</span> <span class=ss>do</span><span class=p>:</span> <span class=n>post</span><span class=o>.</span><span class=n>push_id</span> <span class=o>==</span> <span class=n>push_id</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></div><h2 id=run-the-backend class=headerLink><a href=#run-the-backend class=header-mark></a>Run the Backend</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ mix phx.server
</span></span></code></pre></div><p>Sync endpoint will be available on</p><ul><li>push: <code>POST http://localhost:4000/api/sync/push?lastPulledVersion=&lt;lastPulledVersion></code></li><li>pull: <code>GET http://localhost:4000/api/sync/pull?lastPulledVersion=&lt;lastPulledVersion></code></li></ul><h1 id=whats-next- class=headerLink><a href=#whats-next- class=header-mark></a>What&rsquo;s Next ?</h1><p>We have build a sync backend for WatermelonDB frontend application.
On the next post, we will continue to code the frontend application with sync capability: <a href=https://fahri.id/posts/building-an-offline-first-react-web-app-using-watermelondb-in-phoenix-elixir/ rel>Building an Offline First React Web App Using WatermelonDB in Phoenix (Elixir)</a></p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2020-04-24</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/watermelondb/>WatermelonDB</a>,&nbsp;<a href=/tags/sync-backend/>Sync Backend</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/generate-sequential-uuidv4-in-elixir/ class=prev rel=prev title="Generate Sequential UUIDv4 in Elixir"><i class="fas fa-angle-left fa-fw"></i>Generate Sequential UUIDv4 in Elixir</a>
<a href=/posts/building-an-offline-first-react-web-app-using-watermelondb-in-phoenix-elixir/ class=next rel=next title="Building an Offline-First React Web App Using WatermelonDB in Phoenix (Elixir)">Building an Offline-First React Web App Using WatermelonDB in Phoenix (Elixir)<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=giscus></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://giscus.app/>giscus</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreferrer" title="Hugo 0.109.0">Hugo</a>&nbsp;|&nbsp;Theme - <a href=https://github.com/HEIGE-PCloud/DoIt target=_blank rel="noopener noreferrer" title="DoIt 0.2.13"><i class="far fa-edit fa-fw"></i> DoIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank rel="noopener noreferrer">Fahri</a></span></div><div class=footer-line></div><div class=footer-line></div></div></footer></div><div id=fixed-buttons><a href=#back-to-top id=back-to-top-button class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw"></i></a></div><div class=assets><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/topbar/topbar.min.js></script><script type=text/javascript src=/lib/pjax/pjax.min.js></script><script type=text/javascript src=/js/theme.min.js defer></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-MQ5LN0JS5P")</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-MQ5LN0JS5P" async></script></div><div class=pjax-assets><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:1e4},comment:{giscus:{darkTheme:"dark",dataCategory:"Announcements",dataCategoryId:"DIC_kwDOBdfvTM4CTQ_z",dataEmitMetadata:"0",dataInputPosition:"top",dataLang:"en",dataMapping:"pathname",dataReactionsEnabled:"1",dataRepo:"fahrinh/fahrinh.github.io",dataRepoId:"MDEwOlJlcG9zaXRvcnk5ODAzNzU4MA==",dataStrict:"0",lightTheme:"light"}}}</script><script type=text/javascript src=/js/giscus.min.js defer></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script></div></body></html>